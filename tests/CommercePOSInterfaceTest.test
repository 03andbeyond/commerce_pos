<?php

class CommercePOSInterfaceTest extends CommercePOSBaseTest {
  public $product;

  /** @var POS_State */
  public $state;
  /** @var POS_Command_Registry */
  public $registry;
  /** @var POS_Interface */
  public $interface;

  public static function getInfo() {
    return array(
      'name' => 'Interface Tests',
      'description' => 'Test interface functionality.',
      'group' => 'POS',
    );
  }

  function setUp() {
    parent::setUp();
    $this->drupalLogin($this->storeCashier);

    $this->state = new POS_State();
    $this->registry = new POS_Command_Registry(array(
      new POSCommand_Clear('Clear', 'clear', 'CL'),
    ));
    $this->product = $this->createDummyProduct('testprod', 'Test Product', 5);
    $this->interface = new POS_Interface($this->state, $this->registry, array());
  }

  protected function buildPane(POS_Pane $pane) {
    return $pane->build($this->state, $this->registry);
  }

  function testPrintReceipt() {
    $order = $this->createDummyOrder();
    $this->state->setOrder($order);
    $this->assertEqual(array(), $this->interface->buildAjax(), 'Ajax build is empty before setting print flag.');
    $render = array('#markup' => 1);
    $this->state->setPrintRender($render);
    $output = $this->interface->buildAjax();
    $this->assertEqual($output[0]['command'], 'printReceipt', 'Ajax printReceipt command is given after setting print flag.');

    $this->state->setPrintRender($render);
    $output = $this->interface->build();
    $this->assertEqual($output[0]['print'], $render, 'Receipt is printed on page after setting print flag.');
  }

  function testCommandsPane() {
    $pane = new POSPane_Commands('commands', 'Commands');
    $output = $this->buildPane($pane);
    $this->assertEqual(count($output['#buttons']), 1, 'Commands pane displays 1 button');
    $this->drupalSetContent(drupal_render($output));
    $this->assertRaw('data-pos-input="CL"', 'Clear button contains the correct data property');

    // Check the number pad configuration.
    $this->assertEqual(count($output['#numbers']), 0, 'Commands pane does not display the number pad.');
    $configured_pane = new POSPane_Commands('commands', 'Commands', array('show_keypad' => 1));
    $output = $this->buildPane($configured_pane);
    $this->drupalSetContent(drupal_render($output));
    $this->assertEqual(count($output['#numbers']), 11, 'Commands pane displays the number after configuring.');
    foreach (range(9, 0) as $i) {
      $this->assertRaw('data-pos-input="%s' . $i . '"', format_string('!i button contains the correct data attribute.', array('!i' => $i)));
    }
    $this->assertRaw('data-pos-input="%s*"', 'Asterisk button contains the correct data-attribute.');
  }

  function testInputPane() {
    $pane = new POSPane_Input('input', 'Input');
    $output = $this->buildPane($pane);
    $this->drupalSetContent(drupal_render($output));
    // Make sure the form names/id's match JS expectations.
    $this->assertRaw('id="pos-input-form"', 'Input form ID is correct.');
    $this->assertFieldByName('input', NULL, 'Input field is present.');
  }

  function testOrderPane() {
    $order = $this->createDummyOrder();
    $this->state->setOrder($order);
    $pane = new POSPane_Order('order', 'Order');
    $output = $this->buildPane($pane);
    $this->drupalSetContent(drupal_render($output));
    $this->assertText('Order: ' . $order->order_id, 'Order ID displayed matches the order on the POS.');
    $this->assertText('Customer: ' . $order->uid, 'Customer ID displayed matches the order on the POS.');

    foreach ($order->commerce_line_items[LANGUAGE_NONE] as $item) {
      $this->assertNoRaw('data-pos-input="VOID' . $item['line_item_id'] . '"', 'Void button was not found.');
    }

    // Add the void command to the registry and check that the void button appears.
    $commands = $this->registry->getCommands();
    $commands[] = new POSCommand_Void('Void', 'void', 'VOID%s');
    $this->registry->setCommands($commands);

    $output = $this->buildPane($pane);
    $this->drupalSetContent(drupal_render($output));

    foreach ($order->commerce_line_items[LANGUAGE_NONE] as $item) {
      $this->assertRaw('data-pos-input="VOID' . $item['line_item_id'] . '"', 'Void button was found.');
    }
  }

  function testButtonGeneration() {
    $command = new POSCommand_Clear('Clear', 'clear', 'ABC%s');
    $this->assertFalse($command->getButton(), 'Calling getButton with no input returns false.');
    $button = $command->getButton(NULL, 'test');
    $this->drupalSetContent($button);
    $this->assertRaw('data-pos-input="ABCtest"', 'Data input is set properly.');
    $this->assertRaw('admin/commerce/pos?command=ABCtest', 'Link href is set properly.');
    $this->assertRaw('>Clear<', 'Button text defaults to the command name.');

    $button_name = $this->randomName();
    $button = $command->getButton($button_name, 'test2', array(
      'attributes' => array(
        'class' => 'testClass',
      )
    ));
    $this->drupalSetContent($button);
    $this->assertRaw('>' . $button_name . '<', 'Button name can be changed by the caller.');
    $this->assertRaw('testClass', 'Button attributes can be added by the caller.');

    $this->drupalSetContent($command->getButton('&some more', 'input'));
    $this->assertRaw('>&amp;some more<', 'Button text is escaped once and only once.');

  }
}